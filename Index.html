<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotional Memories Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;700;900&family=Vazirmatn:wght@300;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2d3436;
            --accent: #FF6B6B;
            --text-light: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { 
            height: 100vh; 
            width: 100vw;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
            background-color: #0f0f12;
        }

        /* --- LANDING PAGE STYLES --- */
        #landing {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .shape {
            position: absolute;
            filter: blur(50px);
            z-index: 1;
            opacity: 0.6;
            animation: floatShape 20s infinite alternate;
        }
        .shape-1 {
            top: -10%; left: -10%; width: 50vw; height: 50vw;
            background: #ff9a9e;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
        }
        .shape-2 {
            bottom: -10%; right: -10%; width: 60vw; height: 60vw;
            background: #a18cd1;
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation-delay: -5s;
        }
        .shape-3 {
            top: 40%; left: 40%; width: 30vw; height: 30vw;
            background: #fbc2eb;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation-duration: 25s;
        }

        @keyframes floatShape {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 50px) rotate(20deg); }
        }

        .landing-header {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .landing-logo {
            font-size: 1.2rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .landing-content {
            text-align: center;
            z-index: 10;
            padding: 2rem;
            max-width: 1000px;
            position: relative;
        }

        h1.hero-title {
            font-size: clamp(3rem, 6vw, 6rem);
            font-weight: 900;
            color: white;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            text-shadow: 0 10px 30px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 1s forwards 0.5s;
        }

        p.hero-subtitle {
            font-size: clamp(1.2rem, 2vw, 2rem);
            font-weight: 300;
            color: rgba(255,255,255,0.95);
            margin-bottom: 3rem;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 1s forwards 0.8s;
        }

        .cta-button {
            display: inline-block;
            padding: 1.2rem 3.5rem;
            background: white;
            color: #e73c7e;
            font-size: 1.2rem;
            font-weight: 900;
            text-decoration: none;
            border-radius: 50px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 1s forwards 1.1s;
            cursor: pointer;
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cta-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .lang-btn-landing {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s;
        }
        .lang-btn-landing:hover {
            background: rgba(255,255,255,0.4);
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .loading-spinner {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 3000;
            display: none;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* --- MAP APP STYLES --- */
        #app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        html[dir="rtl"] { --text-align: right; }
        html[dir="ltr"] { --text-align: left; }
        html[lang="fa"] body { font-family: 'Vazirmatn', sans-serif; }

        header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-container { display: flex; flex-direction: column; }
        h1 { font-weight: 900; letter-spacing: -1px; color: var(--primary); font-size: 1.5rem; }
        .tagline { font-size: 0.85rem; color: #666; margin-top: 2px; }

        button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
        }
        .btn-submit { background: var(--primary); color: white; }
        .btn-lang { background: #eee; color: #333; margin-left: 10px; }
        html[dir="rtl"] .btn-lang { margin-left: 0; margin-right: 10px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #map { flex-grow: 1; width: 100%; z-index: 1; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease-out; text-align: var(--text-align);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: #555; }
        input[type="text"], textarea, select {
            width: 100%; padding: 0.8rem; border: 1px solid #ddd;
            border-radius: 6px; font-size: 1rem; font-family: inherit;
        }
        .btn-group { display: flex; gap: 10px; margin-top: 1.5rem; }
        .btn-cancel { background: #eee; color: #333; }

        .legend {
            position: absolute; bottom: 30px; right: 20px;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 999;
            font-size: 0.85rem; text-align: var(--text-align);
        }
        html[dir="rtl"] .legend { right: auto; left: 20px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
        html[dir="rtl"] .dot { margin-right: 0; margin-left: 8px; }

        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 250px !important; text-align: var(--text-align); }
        .popup-header { padding: 10px 15px; color: white; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
        .popup-body { padding: 15px; }
        .popup-title { font-weight: bold; margin-bottom: 5px; color: var(--primary); }
        .popup-text { font-size: 0.9rem; color: #555; line-height: 1.6; font-style: italic; }
        .popup-date { margin-top: 10px; font-size: 0.75rem; color: #999; text-align: inherit; }
        html[dir="rtl"] .popup-date { text-align: left; }

        /* Memory Count */
        .memory-count {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 999;
            font-weight: 600;
        }
        html[dir="rtl"] .memory-count { right: auto; left: 20px; }

    </style>
</head>
<body>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner"></div>

    <!-- LANDING PAGE -->
    <div id="landing">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        
        <div class="landing-header">
            <div class="landing-logo" id="landing-logo">EMOTIONAL MEMORIES MAP</div>
            <button class="lang-btn-landing" onclick="toggleLanguage()" id="btn-lang-landing">فارسی</button>
        </div>
        
        <div class="landing-content">
            <h1 class="hero-title" id="hero-title">Where every place holds a heartbeat of your past.</h1>
            <p class="hero-subtitle" id="hero-subtitle">Pin your memories and let your story live on the map.</p>
            <button class="cta-button" onclick="enterApp()" id="btn-cta">Go to Memories</button>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="app-container">
        <header>
            <div class="brand-container">
                <h1 id="lbl-title">EMOTIONAL MEMORIES MAP</h1>
                <span class="tagline" id="lbl-tagline">A global tapestry of human emotion</span>
            </div>
            <div style="display: flex; align-items: center;">
                <button class="btn-lang" onclick="toggleLanguage()" id="btn-lang">فارسی</button>
                <button class="btn-submit" onclick="openModal(null, true)" id="btn-add">+ Share Memory</button>
            </div>
        </header>

        <div id="map"></div>

        <div class="memory-count">
            <span id="lbl-count">Memories:</span> <span id="memory-count-value">0</span>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="dot" style="background: #FFD700"></div><span id="lbl-joy">Joy</span></div>
            <div class="legend-item"><div class="dot" style="background: #FF6B6B"></div><span id="lbl-love">Love</span></div>
            <div class="legend-item"><div class="dot" style="background: #4A90E2"></div><span id="lbl-loss">Loss</span></div>
            <div class="legend-item"><div class="dot" style="background: #50E3C2"></div><span id="lbl-growth">Growth</span></div>
        </div>

        <!-- Modal Form -->
        <div id="modal-overlay">
            <div class="modal-content">
                <h2 style="margin-bottom: 1rem;" id="lbl-modal-title">Pin a Memory</h2>
                <form id="memoryForm">
                    <div class="form-group">
                        <label id="lbl-input-title">Title</label>
                        <input type="text" id="title" placeholder="..." required>
                    </div>
                    <div class="form-group">
                        <label id="lbl-input-emotion">Emotion</label>
                        <select id="emotion" required>
                            <option value="joy" id="opt-joy">Joy</option>
                            <option value="love" id="opt-love">Love</option>
                            <option value="loss" id="opt-loss">Loss</option>
                            <option value="growth" id="opt-growth">Growth</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="lbl-input-story">Your Story</label>
                        <textarea id="story" rows="4" placeholder="..." required></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn-cancel" onclick="closeModal()" id="btn-cancel">Cancel</button>
                        <button type="submit" class="btn-submit" id="btn-submit">Pin Memory</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ⚠️ REPLACE THIS WITH YOUR FIREBASE CONFIG ⚠️
       // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCUzd5ImJu-9x1FPO0bA9Ne3Y3VIU55VLk",
  authDomain: "emotional-memory-map.firebaseapp.com",
  projectId: "emotional-memory-map",
  storageBucket: "emotional-memory-map.firebasestorage.app",
  messagingSenderId: "1070380538142",
  appId: "1:1070380538142:web:94c24a2542c45fcd26d10f"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.firebaseDB = db;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.collection = collection;
        window.query = query;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
    </script>
    
    <script>
        // --- APP TRANSITION LOGIC ---
        function enterApp() {
            const landing = document.getElementById('landing');
            const app = document.getElementById('app-container');
            const spinner = document.getElementById('loading-spinner');
            
            spinner.style.display = 'block';
            landing.style.opacity = '0';
            landing.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                landing.style.display = 'none';
                app.style.display = 'flex';
                setTimeout(() => { 
                    map.invalidateSize(); 
                    loadMemoriesFromFirebase(); // Load from Firebase instead of localStorage
                }, 100);
            }, 1000);
        }

        // --- TRANSLATION DATA ---
        const translations = {
            en: {
                heroTitle: "Where every place holds a heartbeat of your past.",
                heroSubtitle: "Pin your memories and let your story live on the map.",
                btnCta: "Go to Memories",
                btnLangLanding: "فارسی",
                title: "EMOTIONAL MEMORIES MAP",
                tagline: "A global tapestry of human emotion",
                btnAdd: "+ Share Memory",
                btnLang: "فارسی",
                modalTitle: "Pin a Memory",
                lblTitle: "Title",
                phTitle: "e.g., The day I graduated",
                lblEmotion: "Emotion",
                lblStory: "Your Story",
                phStory: "Tell us what happened here...",
                btnCancel: "Cancel",
                btnSubmit: "Pin Memory",
                alertLoc: "Please click on the map first to select a location!",
                joy: "Joy",
                love: "Love",
                loss: "Loss",
                growth: "Growth",
                optJoy: "Joy",
                optLove: "Love",
                optLoss: "Loss",
                optGrowth: "Growth",
                lblCount: "Memories:"
            },
            fa: {
                heroTitle: "هر مکان، ضربان قلبی از گذشته شما را در خود دارد.",
                heroSubtitle: "خاطرات خود را ثبت کنید و بگذارید داستان شما روی نقشه زنده بماند.",
                btnCta: "ورود به نقشه",
                btnLangLanding: "English",
                title: "نقشه خاطرات عاطفی",
                tagline: "تاریچه‌ای جهانی از احساسات انسانی",
                btnAdd: "+ ثبت خاطره",
                btnLang: "English",
                modalTitle: "ثبت یک خاطره",
                lblTitle: "عنوان",
                phTitle: "مثلاً: روز فارغ‌التحصیلی",
                lblEmotion: "احساس",
                lblStory: "داستان شما",
                phStory: "برای ما بنویسید اینجا چه اتفاقی افتاد...",
                btnCancel: "لغو",
                btnSubmit: "ثبت روی نقشه",
                alertLoc: "لطفاً ابتدا روی نقشه کلیک کنید تا مکان انتخاب شود!",
                joy: "شادی",
                love: "عشق",
                loss: "غم",
                growth: "رشد",
                optJoy: "شادی",
                optLove: "عشق",
                optLoss: "غم",
                optGrowth: "رشد",
                lblCount: "خاطرات:"
            }
        };

        let currentLang = 'en';
        let memories = [];
        let tempLatLng = null;

        // --- MAP INITIALIZATION ---
        const map = L.map('map').setView([20, 0], 3);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap & CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // --- FIREBASE FUNCTIONS ---
        async function loadMemoriesFromFirebase() {
            const spinner = document.getElementById('loading-spinner');
            spinner.style.display = 'block';

            try {
                const memoriesRef = collection(window.firebaseDB, "memories");
                const q = query(memoriesRef, orderBy("createdAt", "desc"));
                const querySnapshot = await window.getDocs(q);
                
                memories = [];
                querySnapshot.forEach((doc) => {
                    memories.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderMarkers();
                updateMemoryCount();
            } catch (error) {
                console.error("Error loading memories:", error);
                alert("Error loading memories. Check Firebase configuration.");
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function saveMemoryToFirebase(memory) {
            const spinner = document.getElementById('loading-spinner');
            spinner.style.display = 'block';

            try {
                const memoriesRef = collection(window.firebaseDB, "memories");
                await window.addDoc(memoriesRef, {
                    ...memory,
                    createdAt: window.serverTimestamp()
                });
                
                // Reload memories to get the new one with ID
                await loadMemoriesFromFirebase();
                return true;
            } catch (error) {
                console.error("Error saving memory:", error);
                alert("Error saving memory. Check Firebase configuration.");
                return false;
            } finally {
                spinner.style.display = 'none';
            }
        }

        // --- FUNCTIONS ---
        const getEmotionColor = (emotion) => {
            const colors = { 'joy': '#FFD700', 'love': '#FF6B6B', 'loss': '#4A90E2', 'growth': '#50E3C2' };
            return colors[emotion] || '#333';
        };

        const createMarkerIcon = (color) => {
            return L.divIcon({
                className: 'custom-pin',
                html: `<div style="background-color: ${color}; width: 100%; height: 100%; border-radius: 50%;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        };

        const renderMarkers = () => {
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            memories.forEach(mem => {
                const color = getEmotionColor(mem.emotion);
                const marker = L.marker([mem.lat, mem.lng], { icon: createMarkerIcon(color) }).addTo(map);
                const emotionLabel = translations[currentLang][mem.emotion] || mem.emotion;
                
                const dateDisplay = mem.createdAt ? 
                    new Date(mem.createdAt.seconds * 1000).toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US') : 
                    mem.date;

                const popupContent = `
                    <div class="popup-header" style="background-color: ${color}">${emotionLabel}</div>
                    <div class="popup-body">
                        <div class="popup-title">${mem.title}</div>
                        <div class="popup-text">"${mem.story}"</div>
                        <div class="popup-date">${dateDisplay}</div>
                    </div>
                `;
                marker.bindPopup(popupContent);
            });
        };

        const updateMemoryCount = () => {
            document.getElementById('memory-count-value').textContent = memories.length;
        };

        // --- LANGUAGE TOGGLE ---
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'fa' : 'en';
            const html = document.documentElement;
            const t = translations[currentLang];

            html.setAttribute('lang', currentLang);
            html.setAttribute('dir', currentLang === 'fa' ? 'rtl' : 'ltr');

            document.getElementById('hero-title').textContent = t.heroTitle;
            document.getElementById('hero-subtitle').textContent = t.heroSubtitle;
            document.getElementById('btn-cta').textContent = t.btnCta;
            document.getElementById('btn-lang-landing').textContent = t.btnLangLanding;

            document.getElementById('lbl-title').textContent = t.title;
            document.getElementById('lbl-tagline').textContent = t.tagline;
            document.getElementById('btn-add').textContent = t.btnAdd;
            document.getElementById('btn-lang').textContent = t.btnLang;
            document.getElementById('lbl-modal-title').textContent = t.modalTitle;
            document.getElementById('lbl-count').textContent = t.lblCount;
            
            document.getElementById('lbl-input-title').textContent = t.lblTitle;
            document.getElementById('title').placeholder = t.phTitle;
            
            document.getElementById('lbl-input-emotion').textContent = t.lblEmotion;
            document.getElementById('opt-joy').textContent = t.optJoy;
            document.getElementById('opt-love').textContent = t.optLove;
            document.getElementById('opt-loss').textContent = t.optLoss;
            document.getElementById('opt-growth').textContent = t.optGrowth;

            document.getElementById('lbl-input-story').textContent = t.lblStory;
            document.getElementById('story').placeholder = t.phStory;

            document.getElementById('btn-cancel').textContent = t.btnCancel;
            document.getElementById('btn-submit').textContent = t.btnSubmit;

            document.getElementById('lbl-joy').textContent = t.joy;
            document.getElementById('lbl-love').textContent = t.love;
            document.getElementById('lbl-loss').textContent = t.loss;
            document.getElementById('lbl-growth').textContent = t.growth;

            renderMarkers();
        }

        // --- INTERACTION ---
        map.on('click', function(e) {
            tempLatLng = e.latlng;
            openModal(e.latlng);
        });

        function openModal(latlng, isDirectClick = false) {
            if(!isDirectClick && !latlng) {
                alert(translations[currentLang].alertLoc);
                return;
            }
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('memoryForm').reset();
            tempLatLng = null;
        }

        document.getElementById('memoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('btn-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'fa' ? 'در حال ثبت...' : 'Saving...';

            const title = document.getElementById('title').value;
            const emotion = document.getElementById('emotion').value;
            const story = document.getElementById('story').value;
            const date = new Date().toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');

            const newMemory = {
                lat: tempLatLng.lat,
                lng: tempLatLng.lng,
                title,
                emotion,
                story,
                date
            };

            const success = await saveMemoryToFirebase(newMemory);
            
            if (success) {
                closeModal();
                map.flyTo([tempLatLng.lat, tempLatLng.lng], 10);
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = currentLang === 'fa' ? 'ثبت روی نقشه' : 'Pin Memory';
        });

        // Initial Render (will be called after Firebase loads)
        renderMarkers();

    </script>
</body>
</html>
